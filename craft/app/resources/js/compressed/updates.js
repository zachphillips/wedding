/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
(function(c){var a=Garnish.Base.extend({$table:null,$tbody:null,init:function(j,e,g){this.$table=c("<table/>").appendTo(j);this.$tbody=c("<tbody/>").appendTo(this.$table);this.addNoteRows(e[0].notes);for(var f=1;f<e.length;f++){var d=e[f],h=g+" "+d.version;if(d.build){h+=' <span class="light">'+Craft.t("build {build}",{build:d.build})+"</span>"}c('<tr><th colspan="2">'+h+"</th></tr>").appendTo(this.$tbody);this.addNoteRows(d.notes)}},addNoteRows:function(f){f=f.split(/[\r\n]+/);for(var e=0;e<f.length;e++){var g=f[e],h=c("<tr/>").appendTo(this.$tbody),d=g.match(/\[(\w+)\]\s*(.+)/);if(d){c('<td class="thin"><span class="category '+d[1].toLowerCase()+'">'+Craft.t(d[1])+"</span></td>").appendTo(h);c("<td>"+d[2]+"</td>").appendTo(h)}else{c('<td colspan="2">'+g+"</td>").appendTo(h)}}}});var b=function(d){for(var e in d){var f=d[e];if(f.releases&&f.releases.length>0){return true}}return false};Craft.postActionRequest("update/getAvailableUpdates",function(d){c("#loading").fadeOut("fast",function(){if(!d.errors&&d.error){d.errors=[d.error]}if(d.errors&&d.errors.length>0){var y=c("#update-error");y.html(d.errors[0]);y.show()}else{if((d.app&&d.app.releases&&d.app.releases.length)){var q=c("#system-updates"),u=q.children("tbody");q.show();if(d.app.releases){var A=c("<tr/>").appendTo(u),g=c("<th/>").appendTo(A),j=c('<td class="thin rightalign"/>').appendTo(A);g.html("Craft "+d.app.releases[0].version+' <span class="light">'+Craft.t("build {build}",{build:d.app.releases[0].build})+"</span>"+(d.app.criticalUpdateAvailable?'<span class="critical">'+Craft.t("Critical")+"</span>":""));var r=function(){var B=d.app.manualDownloadEndpoint;c("<iframe/>",{src:B}).appendTo(Garnish.$bod).hide()};var s=function(){document.location.href=Craft.getUrl("updates/go/craft")};if(d.app.manualUpdateRequired){var p=c('<div class="btn submit">'+Craft.t("Download")+"</div>").appendTo(j)}else{var o=c('<div class="btngroup"/>').appendTo(j),f=c('<div class="btn submit">'+Craft.t("Update")+"</div>").appendTo(o),i=c('<div class="btn submit menubtn"/>').appendTo(o),k=c('<div class="menu" data-align="right"/>').appendTo(o),t=c("<ul/>").appendTo(k),x=c("<li/>").appendTo(t),p=c("<a>"+Craft.t("Download")+"</a>").appendTo(x);new Garnish.MenuBtn(i)}if(d.app.licenseUpdated){var h,m,v,z,w,l;var e=function(B){B.stopPropagation();if(!h){m=c("<form><p>"+Craft.t('Craftâ€™s <a href="http://buildwithcraft.com/license" target="_blank">Terms and Conditions</a> have changed.')+"</p></form>");z=c("<label> "+Craft.t("I agree.")+" &nbsp;</label>").appendTo(m);w=c('<input type="checkbox"/>').prependTo(z);v=c('<input class="btn submit" type="submit"/>').appendTo(m);h=new Garnish.HUD(B.currentTarget,m,{hudClass:"hud",triggerSpacing:20,tipWidth:30});m.on("submit",function(C){C.preventDefault();if(w.prop("checked")){l();h.hide();w.prop("checked",false)}else{Garnish.shake(h.$hud)}})}else{h.$trigger=c(B.currentTarget);h.show()}if(B.currentTarget==p[0]){v.attr("value",Craft.t("Seriously, download."));l=r}else{v.attr("value",Craft.t("Seriously, update."));l=s}};p.on("click",e);if(typeof f!="undefined"){f.on("click",e)}}else{p.on("click",r);if(typeof f!="undefined"){f.on("click",s)}}var A=c("<tr/>").appendTo(u),j=c('<td class="notes" colspan="2"/>').appendTo(A);new a(j,d.app.releases,"Craft")}}else{c("#no-system-updates").show()}c("#updates").fadeIn("fast");var n=0;if(d.app&&d.app.releases){n++}if(b(d.plugins)){n++}if(n>=2){c("#update-all").fadeIn("fast")}}})})})(jQuery);